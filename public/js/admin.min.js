"use strict";var timeoutHandler=function(a,b){if("error"===b){var c="object"==typeof a?JSON.stringify(a):a;c&&-1===c.indexOf("Not authorized")?window.location.reload():window.location.href="/login/timeout"}},ElementSelector={currentElement:null,newVersions:{},createElementVersion:function(a){a=$(a);var b=a.attr("data-id");b&&$.ajax({url:"/admin/create-pageelement-version",type:"post",data:{id:b},success:function(){$(".page-element").load("/admin/page-element-form",{id:b},timeoutHandler)},error:timeoutHandler})},createAppVersion:function(){$.ajax({url:"/admin/create-app-version",type:"post",data:{tag:$("#tagName").val()},success:function(){window.location.href="/cms"},error:timeoutHandler})},restoreVersion:function(a,b){a=$(a);var c=a.attr("data-id");c&&$.ajax({url:"/admin/restore-pageelement-version",type:"post",data:{id:c,version:b},success:function(d,e){"OK"===d.status?($(ElementSelector.currentElement).replaceWith($(d.html).addClass("active")),ElementSelector.currentElement=$(".app .element.active"),$(a).removeClass("error"),$(".page-element").load("/admin/page-element-form",{id:c},function(){$('[data-id="'+b+'"]').addClass("active")})):($(a).addClass("error"),timeoutHandler(d,e))},error:timeoutHandler})},selectElement:function(a){ElementSelector.currentElement=$('.app .element[data-id="'+a+'"]'),$(".element").removeClass("active").filter('[data-id="'+a+'"]').addClass("active"),$(".page-element").load("/admin/page-element-form",{id:a},timeoutHandler)},changeValue:function(a,b,c,d){a.data("last-save")!==a.val()&&(a.data("last-save",a.val()),$.ajax({url:"/admin/save-property-value",type:"post",data:{value:c,id:b,newVersion:ElementSelector.newVersions[a.prop("name")]},dataType:"json",success:function(b,c){"OK"===b.status?(d.replaceWith($(b.html).addClass("active")),ElementSelector.currentElement=$(".app .element.active"),a.removeClass("error").data("last-save",a.val()),$("#version-elements a.restore-version.active").removeClass("active")):(a.addClass("error"),timeoutHandler(b,c))},error:timeoutHandler}),ElementSelector.newVersions[a.prop("name")]=!1)}};$(document).ready(function(){if($(".sections.header .table-of-contents a").each(function(){-1!==location.pathname.indexOf($(this).attr("href"))&&$(this).parents("li").addClass("selected")}),$(document).on("click",".newVersion",function(){null!==ElementSelector.currentElement&&ElementSelector.createElementVersion(ElementSelector.currentElement)}),function(a){var b=location.pathname.split("/")[1]||"cms",c=JSON.parse($.cookie(a)||"{}"),d=c[b];$(".cms.toolbox .group").each(function(a){d&&$(this).toggleClass("collapsed",1!==d[a])}),$(".cms.toolbox").on("click",".group-header a",function(b){b.preventDefault();var c=location.pathname.split("/")[1]||"cms",d=JSON.parse($.cookie(a)||"{}");$(this).closest(".group").toggleClass("collapsed"),d[c]=[],$(".cms.toolbox .group").each(function(){d[c].push($(this).is(".collapsed")?0:1)}),$.cookie(a,JSON.stringify(d),{path:"/"})})}("cms.toolbox.groups"),$(".app").on("click","[href]",function(a){a.preventDefault()}),$(document).on("click",".element",function(a){a.preventDefault();var b=$(this),c=b.attr("data-id");if($("#toolbox-elements").find('[data-id="'+c+'"]').size()){if(b.parents("#toolbox-elements").size()){var d=$(".app"),e={top:$(".cms.header").height(),bottom:$(window).height()},f=d.find('[data-id="'+c+'"]'),g=f.offset().top,h=g+f.height(),i=d.height()/4;(g<e.top||h>e.bottom)&&(f[0].scrollIntoView(!0),f.offset().top<e.top+i&&d.scrollTop(d.scrollTop()-i))}ElementSelector.selectElement(c)}}),$("#toolbox-elements .element").length>0&&ElementSelector.selectElement($("#toolbox-elements .element").first().attr("data-id")),$(document).on("focus",".page-element-property input, .page-element-property textarea",function(){ElementSelector.newVersions[$(this).prop("name")]=!0}),$(document).on("click",".app-version-restore",function(){if(!confirm("Do you want to restore this snapshot?"))return!1;var a=$(this).attr("data-id");return $.ajax({url:"/admin/restore-app-version",type:"post",data:{id:a,pages:$("input#restorePages").prop("checked"),settings:$("input#restoreSettings").prop("checked"),brandings:$("input#restoreBrandings").prop("checked")},success:function(a,b){"OK"==a.status?window.location.reload():timeoutHandler(a,b)},error:timeoutHandler}),!1}),$(".autosave").each(function(){var a=$(this);a.data("last-save",a.val())}),$(document).on("blur",".page-element-property input, .page-element-property textarea",function(){ElementSelector.changeValue($(this),$(this).attr("data-id"),$(this).val(),$(".app .element.active"))}),$(".cms.settings, .cms.ci").each(function(){$(document).on("blur",".autosave",function(){var a=$(this);a.data("last-save")!==a.val()&&(a.data("last-save",a.val()),$.ajax({url:location.pathname+("/"===location.pathname.slice(-1)?"":"/")+"save",type:"post",data:{name:a.attr("name"),value:a.val()},dataType:"json",success:function(b,c){"OK"==b.status?(a.removeClass("error"),$(".cms.ci").each(function(){$("#brandingcss").attr("href","/css/branding.css?time="+(new Date).getTime())}),"undefined"!=typeof b.value&&(a.val(b.value),a.data("last-save",b.value))):(a.addClass("error"),timeoutHandler(b,c))},error:timeoutHandler}))}),$(this).is(".ci")&&$(".upload").on("change",function(){var a=$(this);if(a.val()){var b=a.parents("form");b.iframePostForm({iframeID:b.find("iframe").attr("id"),json:!0,complete:function(b){var c;"OK"===b.status&&(c=b.value,a.next(".preview").find("img").attr("src",c),$("#company img").attr("src",c))}}).submit()}})}),$(document).on("click",".action.change-password",function(){window.location.href="/cms/change-password"}),$(document).on("click",".create-app-version",function(){return ElementSelector.createAppVersion(),!1}),$(document).on("click",".restore-version",function(a){return a.preventDefault(),ElementSelector.restoreVersion(ElementSelector.currentElement,$(this).closest("li").attr("data-id")),!1}),-1!==location.pathname.indexOf("/cms")&&location.search){var a={user:"Password",live:"Application status",reset:"Database"},b=location.search.slice(1).split("-"),c=a[b[0]],d="OK"!==b[1],e=$(".segment."+b[0]);c&&(e.append($("<div/>").addClass("attention").addClass(d?"failure":"success").text(c+(d?" has not been updated.":" has been updated."))),e.find(".attention").append($("<div/>").addClass("highlight")),e.find(".highlight").fadeOut(2e3))}$(document).on("click",".action[data-request]",function(){var a=$(this).data("request");return a.confirm&&!confirm(a.confirm)?!1:($.ajax({url:a.url,type:"post",success:function(b){a.redirect&&(window.location.href=a.redirect.replace(/@/,b.status))},error:function(b,c){a.redirect?window.location.href=a.redirect.replace(/@/,"ERR"):timeoutHandler(b,c)}}),!1)}),$(document).on("click",".version-item .remove",function(){return confirm("Do you really want to remove this version?")?($.ajax({url:"/admin/remove-pageelement-version",type:"post",data:{id:$(this).closest("li").attr("data-id")},success:function(a,b){if("OK"==a.status){var c=$(ElementSelector.currentElement).attr("data-id");$(".page-element").load("/admin/page-element-form",{id:c},timeoutHandler)}else timeoutHandler(a,b)},error:timeoutHandler}),!1):!1}),$(document).on("click",".app-version-item .remove",function(){return confirm("Do you really want to remove this snapshot?")?($.ajax({url:"/admin/remove-app-version",type:"post",data:{id:$(this).closest("li").attr("data-id")},success:function(){window.location.href="/cms"},error:timeoutHandler}),!1):!1})});